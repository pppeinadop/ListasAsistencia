<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Asistencia">
    
    <title>Asistencia - Dr. Peinado</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1C1C1E; --secondary: #8E8E93; --success: #34C759; --danger: #FF3B30; --warning: #FF9500; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .screen { display: none; width: 100%; max-width: 500px; }
        .active { display: block; }
        
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: var(--secondary); }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #DDD; border-radius: 12px; font-size: 16px; outline: none; }
        
        .btn { width: 100%; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-ghost { background: none; color: var(--primary); }

        .item-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #F2F2F7; border-radius: 10px; }
        .item-row:hover { background: #F9F9F9; }
        .info { flex: 1; }
        
        .actions { display: flex; gap: 5px; }
        .icon-btn { cursor: pointer; padding: 8px; border-radius: 8px; font-size: 16px; transition: 0.2s; background: #f0f0f0; }
        .icon-btn:hover { background: #e0e0e0; }

        .import-input { display: none; }
    </style>
</head>
<body>

    <div id="home" class="screen active">
        <h1 style="text-align:center">Dr. Peinado</h1>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <button class="card" style="border:none; cursor:pointer" onclick="navegar('escuelas')">üè´<br>Escuelas</button>
            <button class="card" style="border:none; cursor:pointer" onclick="navegar('grupos')">üë•<br>Grupos</button>
        </div>
    </div>

    <div id="escuelas" class="screen">
        <button class="btn-ghost" onclick="navegar('home')">‚ùÆ Volver</button>
        <div class="card">
            <h3 id="tituloEscuela">Nueva Escuela</h3>
            <input type="hidden" id="keyEscuela">
            <input type="text" id="nomEsc" placeholder="Nombre Completo" style="margin-bottom:10px">
            <input type="text" id="apiEsc" placeholder="Siglas (UACH, etc)">
            <button class="btn btn-primary" onclick="guardarEscuela()">Guardar</button>
        </div>
        <div class="card" id="listaEscuelas"></div>
    </div>

    <div id="grupos" class="screen">
        <button class="btn-ghost" onclick="navegar('home')">‚ùÆ Volver</button>
        <div class="card">
            <h3 id="tituloGrupo">Nuevo Grupo</h3>
            <input type="hidden" id="keyGrupo">
            <div class="form-group">
                <label>Escuela</label>
                <select id="selEscuela"><option value="">Cargando...</option></select>
            </div>
            <div class="form-group">
                <label>Nombre del Grupo</label>
                <input type="text" id="nomGrupo" placeholder="Ej. 2do A - Anatom√≠a">
            </div>
            <button class="btn btn-success" id="btnGrup" onclick="guardarGrupo()">Crear Grupo</button>
            <button id="btnCancG" style="display:none; color:red; background:none; border:none; width:100%; margin-top:10px" onclick="resetGrupo()">Cancelar</button>
        </div>
        
        <input type="file" id="fileImport" class="import-input" accept=".xlsx, .xls" onchange="procesarExcel(event)">
        
        <div class="card">
            <h3>Mis Grupos</h3>
            <div id="listaGrupos"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9uPSxhyy7JJ_05gc00PNcyN31Z3bbzPo",
            authDomain: "listasasistencia-3a3ca.firebaseapp.com",
            databaseURL: "https://listasasistencia-3a3ca-default-rtdb.firebaseio.com",
            projectId: "listasasistencia-3a3ca",
            storageBucket: "listasasistencia-3a3ca.firebasestorage.app",
            messagingSenderId: "892289957745",
            appId: "1:892289957745:web:3a1b93b635bcc9db08c0d0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let grupoSeleccionadoParaImportar = null;

        function navegar(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- GRUPOS ---
        function guardarGrupo() {
            const escId = document.getElementById('selEscuela').value;
            const escTxt = document.getElementById('selEscuela').options[document.getElementById('selEscuela').selectedIndex].text;
            const nomG = document.getElementById('nomGrupo').value;
            const key = document.getElementById('keyGrupo').value;

            if(!escId || !nomG) return alert("Completa los datos");

            const data = { escId, escTxt, nomGrupo: nomG };
            if(key) {
                db.ref('grupos/' + key).update(data).then(() => { alert("Grupo actualizado"); resetGrupo(); });
            } else {
                db.ref('grupos').push(data).then(() => { alert("Grupo creado"); resetGrupo(); });
            }
        }

        function resetGrupo() {
            document.getElementById('keyGrupo').value = "";
            document.getElementById('nomGrupo').value = "";
            document.getElementById('tituloGrupo').innerText = "Nuevo Grupo";
            document.getElementById('btnGrup').innerText = "Crear Grupo";
            document.getElementById('btnCancG').style.display = "none";
        }

        function editarGrupo(key, idEsc, nombre) {
            document.getElementById('keyGrupo').value = key;
            document.getElementById('selEscuela').value = idEsc;
            document.getElementById('nomGrupo').value = nombre;
            document.getElementById('tituloGrupo').innerText = "Editando Grupo";
            document.getElementById('btnGrup').innerText = "Actualizar";
            document.getElementById('btnCancG').style.display = "block";
            window.scrollTo(0,0);
        }

        function eliminarGrupo(key) {
            if(confirm("¬øEliminar grupo y sus alumnos?")) db.ref('grupos/' + key).remove();
        }

        // --- IMPORTAR EXCEL ---
        function dispararImportar(key) {
            grupoSeleccionadoParaImportar = key;
            document.getElementById('fileImport').click();
        }

        function procesarExcel(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = evt.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const firstSheet = workbook.SheetNames[0];
                const rows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[firstSheet]);
                
                rows.forEach(row => {
                    const nombreAlumno = row.Nombre || row.nombre || row.NOMBRE;
                    if(nombreAlumno) {
                        db.ref('alumnos/' + grupoSeleccionadoParaImportar).push({ nombre: nombreAlumno });
                    }
                });
                alert("Importaci√≥n completada con √©xito");
                e.target.value = ""; // Limpiar input
            };
            reader.readAsBinaryString(file);
        }

        // --- RENDERIZADO TIEMPO REAL ---
        db.ref('escuelas').on('value', snap => {
            const d = snap.val();
            const sel = document.getElementById('selEscuela');
            sel.innerHTML = '<option value="">-- Selecciona Escuela --</option>';
            if(d) Object.keys(d).forEach(k => sel.innerHTML += `<option value="${k}">${d[k].apodo}</option>`);
        });

        db.ref('grupos').on('value', snap => {
            const d = snap.val();
            const cont = document.getElementById('listaGrupos');
            cont.innerHTML = "";
            if(!d) return cont.innerHTML = "No hay grupos.";
            Object.keys(d).forEach(k => {
                cont.innerHTML += `
                    <div class="item-row">
                        <div class="info">
                            <strong>${d[k].nomGrupo}</strong><br>
                            <small>${d[k].escTxt}</small>
                        </div>
                        <div class="actions">
                            <span class="icon-btn" title="Importar Excel" onclick="dispararImportar('${k}')">üì•</span>
                            <span class="icon-btn" title="Editar" onclick="editarGrupo('${k}','${d[k].escId}','${d[k].nomGrupo}')">‚úèÔ∏è</span>
                            <span class="icon-btn" title="Eliminar" onclick="eliminarGrupo('${k}')">üóëÔ∏è</span>
                        </div>
                    </div>`;
            });
        });
    </script>
</body>
</html>