<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dr. Peinado - Control Total</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1C1C1E; --secondary: #8E8E93; --danger: #FF3B30; --success: #34C759; --warning: #FF9500; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); overflow-x: hidden; padding-top: 60px; }
        
        #status-bar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #ddd; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        .screen { display: none; width: 100%; max-width: 800px; margin: auto; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .menu-item { aspect-ratio: 1/1; background: white; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 16px; }
        .menu-item span { font-size: 40px; margin-bottom: 8px; }

        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: bold; font-size: 16px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
        .btn-back { background: none; color: var(--primary); font-size: 17px; font-weight: 600; padding: 10px 0; border: none; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #E5E5EA; background: #F2F2F7; font-size: 16px; }
        
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #ddd; margin-top: 15px; max-height: 60vh; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; min-width: 60px; }
        .sticky-col { position: sticky; left: 0; background: white; font-weight: bold; z-index: 5; border-right: 2px solid #ddd; min-width: 140px; text-align: left; }
        
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .dot-si { background: var(--success); }
        .dot-no { background: var(--danger); }
        .delete-header { color: var(--danger); font-size: 9px; display: block; margin-top: 4px; }
    </style>
</head>
<body>

    <div id="status-bar">
        <div>
            <span id="conn-dot" class="status-dot" style="background:gray"></span>
            <span id="conn-text" style="font-weight: 800;">Cargando...</span>
        </div>
        <button onclick="forzarRespaldo()" style="background: var(--primary); color:white; border:none; padding:5px 12px; border-radius:12px; font-size:10px;">RESPALDAR IPAD</button>
    </div>

    <div id="home" class="screen active">
        <h1 style="text-align:center; color: var(--primary);">Dr. Peinado</h1>
        <div class="menu-grid">
            <button class="menu-item" onclick="navegar('escuelas')"><span>üè´</span>Escuelas</button>
            <button class="menu-item" onclick="navegar('grupos')"><span>üë•</span>Grupos</button>
            <button class="menu-item" onclick="navegar('asistencia')"><span>‚è±Ô∏è</span>Lista</button>
            <button class="menu-item" onclick="navegar('reportes')"><span>üìä</span>Reportes</button>
        </div>
        <p style="text-align:center; font-size:11px; color:var(--secondary); margin-top:20px;">Copia local: <span id="last-sync">--</span></p>
    </div>

    <div id="reportes" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>üìä Consultar Reporte</h3>
            <select id="selRepE" onchange="cargarGruposFiltro('selRepE', 'selRepG')"></select>
            <select id="selRepG"></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="date" id="fInicio">
                <input type="date" id="fFin">
            </div>
            <button class="btn" style="background:var(--primary)" onclick="verReporte()">üîç Ver Datos Actualizados</button>
        </div>
        <div id="rep-box" class="card" style="display:none">
            <div class="table-container">
                <table id="tabla-final">
                    <thead id="th-rep"></thead>
                    <tbody id="tb-rep"></tbody>
                </table>
            </div>
            <button class="btn" style="background:var(--warning)" onclick="exportarExcel()">üì• Guardar Excel</button>
        </div>
    </div>

    <div id="asistencia" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div id="asis-prep" class="card">
            <select id="selAsisE" onchange="cargarGruposFiltro('selAsisE', 'selAsisG')"></select>
            <select id="selAsisG"></select>
            <button class="btn" style="background:var(--primary)" onclick="comenzarLista()">Comenzar Lista</button>
        </div>
        <div id="asis-play" class="card" style="display:none; text-align:center">
            <div id="asis-meta" style="font-size: 12px; color: var(--secondary);"></div>
            <div id="alu-name" style="font-size:30px; font-weight:800; margin:30px 0; min-height:80px; display:flex; align-items:center; justify-content:center;"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <button class="btn" style="background:var(--danger); padding:35px;" onclick="marcar(false)">FALTA</button>
                <button class="btn" style="background:var(--success); padding:35px;" onclick="marcar(true)">PRESENTE</button>
            </div>
        </div>
    </div>

    <div id="escuelas" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <input type="text" id="inNombreE" placeholder="Nombre Escuela">
            <input type="text" id="inApodoE" placeholder="Siglas">
            <button class="btn" style="background:var(--primary)" onclick="crearEscuela()">Guardar</button>
            <div id="displayEscuelas"></div>
        </div>
    </div>
    <div id="grupos" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <select id="selEscuelaGrupo"></select>
            <input type="text" id="inNombreG" placeholder="Nombre Grupo">
            <button class="btn" style="background:var(--success)" onclick="crearGrupo()">Crear</button>
            <div id="displayGrupos"></div>
        </div>
        <input type="file" id="inputExcel" style="display:none" onchange="procesarExcel(event)">
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9uPSxhyy7JJ_05gc00PNcyN31Z3bbzPo",
            databaseURL: "https://listasasistencia-3a3ca-default-rtdb.firebaseio.com",
            projectId: "listasasistencia-3a3ca",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let APP_DATA = JSON.parse(localStorage.getItem('backup_dr_peinado')) || { escuelas: {}, grupos: {}, alumnos: {} };
        let index = 0; let lista = []; let gIdActual = ""; let sIdActual = "";

        // SINCRONIZACI√ìN
        function forzarRespaldo() {
            if(!navigator.onLine) return;
            db.ref('/').once('value').then(snap => {
                const data = snap.val();
                if(data) {
                    APP_DATA = data;
                    localStorage.setItem('backup_dr_peinado', JSON.stringify(data));
                    localStorage.setItem('dr_peinado_time', new Date().toLocaleString());
                    renderTodo();
                    document.getElementById('last-sync').innerText = localStorage.getItem('dr_peinado_time');
                }
            });
        }

        db.ref(".info/connected").on("value", (snap) => {
            const dot = document.getElementById('conn-dot');
            const txt = document.getElementById('conn-text');
            if (snap.val() === true) {
                dot.style.background = "var(--success)"; txt.innerText = "SINCRO";
                forzarRespaldo();
            } else {
                dot.style.background = "var(--warning)"; txt.innerText = "LOCAL";
            }
            renderTodo();
        });

        function navegar(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'reportes') {
                document.getElementById('fInicio').value = "2026-02-01";
                document.getElementById('fFin').value = new Date().toISOString().split('T')[0];
            }
        }

        function renderTodo() {
            const esc = APP_DATA.escuelas || {};
            const gru = APP_DATA.grupos || {};
            ['selEscuelaGrupo', 'selAsisE', 'selRepE'].forEach(id => {
                const s = document.getElementById(id);
                if(s) {
                    s.innerHTML = '<option value="">-- Escuela --</option>';
                    Object.keys(esc).forEach(k => s.innerHTML += `<option value="${k}">${esc[k].apodo}</option>`);
                }
            });
            const dE = document.getElementById('displayEscuelas');
            if(dE) {
                dE.innerHTML = "";
                Object.keys(esc).forEach(k => dE.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${esc[k].apodo}</b> <button onclick="borrar('escuelas','${k}')">üóëÔ∏è</button></div>`);
            }
            const dG = document.getElementById('displayGrupos');
            if(dG) {
                dG.innerHTML = "";
                Object.keys(gru).forEach(k => dG.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">${gru[k].nombreGrupo} <button onclick="preparaExcel('${k}')">üì•</button> <button onclick="borrar('grupos','${k}')">üóëÔ∏è</button></div>`);
            }
        }

        function cargarGruposFiltro(idE, idG) {
            const eId = document.getElementById(idE).value;
            const selG = document.getElementById(idG);
            selG.innerHTML = '<option value="">-- Grupo --</option>';
            const gs = APP_DATA.grupos || {};
            Object.keys(gs).forEach(k => { if(gs[k].escuelaId === eId) selG.innerHTML += `<option value="${k}">${gs[k].nombreGrupo}</option>`; });
        }

        // L√ìGICA DE LISTA
        function comenzarLista() {
            gIdActual = document.getElementById('selAsisG').value;
            if(!gIdActual) return alert("Selecciona grupo");
            const alumnos = (APP_DATA.alumnos && APP_DATA.alumnos[gIdActual]) ? APP_DATA.alumnos[gIdActual] : {};
            lista = Object.keys(alumnos).map(k => ({id:k, nombre:alumnos[k].nombre}));
            if(lista.length === 0) return alert("Sin alumnos en copia local.");
            const d = new Date();
            sIdActual = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}_${d.getHours().toString().padStart(2,'0')}${d.getMinutes().toString().padStart(2,'0')}`;
            document.getElementById('asis-prep').style.display = 'none';
            document.getElementById('asis-play').style.display = 'block';
            index = 0; dibujarAlumno();
        }

        function dibujarAlumno() {
            if(index < lista.length) {
                document.getElementById('alu-name').innerText = lista[index].nombre;
                document.getElementById('asis-meta').innerText = `ALUMNO ${index + 1} DE ${lista.length}`;
            } else {
                alert("¬°Lista terminada!");
                forzarRespaldo(); // Intentar subir y refrescar al terminar
                navegar('home');
            }
        }

        function marcar(p) {
            db.ref(`asistencias/${gIdActual}/${sIdActual}/${lista[index].id}`).set({ nombre: lista[index].nombre, presente: p });
            index++; dibujarAlumno();
        }

        // REPORTE CON ELIMINACI√ìN
        function verReporte() {
            const g = document.getElementById('selRepG').value;
            const ini = document.getElementById('fInicio').value;
            const fin = document.getElementById('fFin').value;
            if(!g) return alert("Selecciona grupo");

            // Leemos directamente de Firebase para asegurar que el d√≠a reci√©n tomado aparezca
            db.ref(`asistencias/${g}`).once('value').then(snap => {
                const asistencias = snap.val() || {};
                const sesiones = Object.keys(asistencias).filter(s => s.split('_')[0] >= ini && s.split('_')[0] <= fin).sort();
                
                if(sesiones.length === 0) {
                    alert("No hay registros para este grupo en esas fechas.");
                    document.getElementById('rep-box').style.display = 'none';
                    return;
                }

                document.getElementById('rep-box').style.display = 'block';
                let h = `<tr><th class="sticky-col">Alumno</th>`;
                sesiones.forEach(s => {
                    const fechaTxt = s.split('_')[0].slice(-5).replace('-', '/');
                    h += `<th onclick="eliminarSesion('${g}','${s}')">${fechaTxt}<span class="delete-header">Eliminar</span></th>`;
                });
                document.getElementById('th-rep').innerHTML = h + `</tr>`;

                const alus = APP_DATA.alumnos[g] || {};
                let b = "";
                Object.keys(alus).forEach(aId => {
                    b += `<tr><td class="sticky-col">${alus[aId].nombre}</td>`;
                    sesiones.forEach(s => {
                        const reg = asistencias[s][aId];
                        const p = reg ? reg.presente : null;
                        b += `<td>${p === null ? '-' : (p ? '<div class="dot dot-si"></div>' : '<div class="dot dot-no"></div>')}</td>`;
                    });
                    b += `</tr>`;
                });
                document.getElementById('tb-rep').innerHTML = b;
            });
        }

        function eliminarSesion(gId, sId) {
            const fecha = sId.split('_')[0];
            if(confirm(`¬øEst√°s seguro de eliminar permanentemente la lista del d√≠a ${fecha}?`)) {
                db.ref(`asistencias/${gId}/${sId}`).remove().then(() => {
                    alert("Sesi√≥n eliminada.");
                    verReporte(); // Refrescar tabla
                });
            }
        }

        // FUNCIONES ADICIONALES
        function crearEscuela() {
            const n = document.getElementById('inNombreE').value; const a = document.getElementById('inApodoE').value;
            if(n && a) db.ref('escuelas').push({nombre:n, apodo:a}).then(() => { document.getElementById('inNombreE').value=""; document.getElementById('inApodoE').value=""; });
        }
        function crearGrupo() {
            const e = document.getElementById('selEscuelaGrupo').value; const n = document.getElementById('inNombreG').value;
            if(e && n) db.ref('grupos').push({escuelaId:e, nombreGrupo:n, estado:'activo'}).then(() => { document.getElementById('inNombreG').value=""; });
        }
        function borrar(p, id) { if(confirm("¬øBorrar definitivamente?")) db.ref(`${p}/${id}`).remove(); }
        
        let gExcel = "";
        function preparaExcel(id) { gExcel = id; document.getElementById('inputExcel').click(); }
        function procesarExcel(e) {
            const f = e.target.files[0]; const r = new FileReader();
            r.onload = (evt) => {
                const b = XLSX.read(evt.target.result, {type:'binary'});
                const d = XLSX.utils.sheet_to_json(b.Sheets[b.SheetNames[0]], {header:1});
                d.forEach(row => { if(row[0]) db.ref('alumnos/'+gExcel).push({nombre: row[0].toString().toUpperCase()}); });
                alert("Alumnos cargados.");
            };
            r.readAsBinaryString(f);
        }

        function exportarExcel() {
            const t = document.getElementById('tabla-final').cloneNode(true);
            t.querySelectorAll('.delete-header').forEach(el => el.remove()); // Limpiar Excel
            XLSX.writeFile(XLSX.utils.table_to_book(t), "Reporte_Asistencia.xlsx");
        }
    </script>
</body>
</html>