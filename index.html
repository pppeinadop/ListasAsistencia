<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dr. Peinado - Asistencia Pro</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1C1C1E; --secondary: #8E8E93; --danger: #FF3B30; --success: #34C759; --warning: #FF9500; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); overflow-x: hidden; }
        .screen { display: none; width: 100%; max-width: 900px; margin: auto; animation: fadeIn 0.2s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #status-bar { position: fixed; top: 10px; right: 15px; font-size: 11px; font-weight: bold; z-index: 1000; display: flex; align-items: center; background: rgba(255,255,255,0.9); padding: 5px 12px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; margin-right: 7px; transition: background 0.3s; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 500px; margin: 40px auto; padding: 10px; }
        .menu-item { aspect-ratio: 1 / 1; background: white; border-radius: 28px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.08); color: var(--text); }
        .menu-item span { font-size: 55px; margin-bottom: 12px; display: block; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: white; -webkit-user-select: text; }
        .back-btn { background: none; color: var(--primary); border: none; padding: 10px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .live-clock { background: #f0f7ff; border: 1.5px solid var(--primary); padding: 15px; border-radius: 15px; margin-bottom: 15px; color: var(--primary); font-weight: 800; font-size: 18px; text-align: center; }
        .item-list { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .item-actions { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; border: 1px solid #ddd; max-height: 55vh; }
        table { border-collapse: separate; border-spacing: 0; background: white; min-width: 100%; }
        .name-col { text-align: left; font-weight: bold; min-width: 150px; background: white !important; position: sticky; left: 0; z-index: 5; border-right: 2px solid #ddd !important; }
        .dot { height: 16px; width: 16px; border-radius: 50%; display: inline-block; }
        .dot-si { background-color: var(--success); }
        .dot-no { background-color: var(--danger); }
    </style>
</head>
<body>

    <div id="status-bar">
        <div id="status-dot-ui" class="status-dot" style="background: gray;"></div>
        <span id="status-text-ui">Cargando...</span>
    </div>

    <div id="home" class="screen active">
        <h1 style="text-align:center; margin-top: 60px; font-size: 28px; font-weight: 800; color: var(--primary);">Dr. Peinado</h1>
        <div class="menu-grid">
            <button class="menu-item" onclick="navegar('escuelas')"><span>üè´</span>Escuelas</button>
            <button class="menu-item" onclick="navegar('grupos')"><span>üë•</span>Grupos</button>
            <button class="menu-item" onclick="navegar('asistencia')"><span>‚è±Ô∏è</span>Lista</button>
            <button class="menu-item" onclick="navegar('reportes')"><span>üìä</span>Reporte</button>
        </div>
        <button class="btn" style="background:#5856D6" onclick="location.reload()">üîÑ Forzar Recarga</button>
    </div>

    <div id="escuelas" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>Escuelas</h3>
            <input type="text" id="nombreEscuela" placeholder="Nombre de la Escuela">
            <input type="text" id="apodoEscuela" placeholder="Siglas">
            <button class="btn" style="background:var(--primary)" onclick="guardarEscuela()">Guardar</button>
            <div id="listaEscuelas"></div>
        </div>
    </div>

    <div id="grupos" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>Grupos</h3>
            <select id="selectEscuelaGrupo"></select>
            <input type="text" id="nombreGrupo" placeholder="Nombre del Grupo">
            <button class="btn" style="background:var(--success)" onclick="guardarGrupo()">Crear Grupo</button>
            <div id="listaGroups"></div>
            <hr><h4 style="color:var(--secondary)">üìÅ Archivados</h4>
            <div id="listaArchivados"></div>
        </div>
        <input type="file" id="inputExcel" style="display:none" accept=".xlsx, .xls" onchange="leerExcel(event)">
    </div>

    <div id="asistencia" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div id="asistencia-seleccion" class="card">
            <div id="reloj-vivo" class="live-clock">--:--:--</div>
            <select id="asis-escuela" onchange="filtrarGrupos('asis-escuela', 'asis-grupo')"></select>
            <select id="asis-grupo"></select>
            <button class="btn" style="background:var(--primary)" onclick="iniciarPasarLista()">Comenzar Lista</button>
        </div>
        <div id="asistencia-flujo" class="card" style="display:none; text-align:center">
            <div id="contador-alu" style="font-size: 14px; color:var(--secondary)"></div>
            <div id="nombre-display" style="font-size:32px; font-weight:800; margin:25px 0; color:var(--primary); min-height: 100px; display:flex; align-items:center; justify-content:center;"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <button class="btn" style="background:var(--danger); padding:40px; font-size:24px" onclick="registrarAsis(false)">FALTA</button>
                <button class="btn" style="background:var(--success); padding:40px; font-size:24px" onclick="registrarAsis(true)">PRESENTE</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                <button class="btn" style="background:#E5E5EA; color:black;" onclick="cambiarAlumno(-1)">‚ùÆ Ant.</button>
                <button class="btn" style="background:#E5E5EA; color:black;" onclick="cambiarAlumno(1)">Sig. ‚ùØ</button>
            </div>
        </div>
    </div>

    <div id="reportes" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <select id="rep-escuela" onchange="filtrarGrupos('rep-escuela', 'rep-grupo')"></select>
            <select id="rep-grupo"></select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                <input type="date" id="fecha-inicio">
                <input type="date" id="fecha-fin">
            </div>
            <button class="btn" style="background:var(--primary)" onclick="consultarReporte()">üîç Ver Reporte</button>
            <div id="reporte-tabla-cont" style="display:none">
                <div class="table-container">
                    <table id="tabla-datos"><thead id="head-reporte"></thead><tbody id="body-reporte"></tbody></table>
                </div>
                <button class="btn" style="background:var(--warning)" onclick="exportarExcelAF()">Exportar Excel üì•</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9uPSxhyy7JJ_05gc00PNcyN31Z3bbzPo",
            authDomain: "listasasistencia-3a3ca.firebaseapp.com",
            databaseURL: "https://listasasistencia-3a3ca-default-rtdb.firebaseio.com",
            projectId: "listasasistencia-3a3ca",
            storageBucket: "listasasistencia-3a3ca.firebasestorage.app",
            messagingSenderId: "892289957745",
            appId: "1:892289957745:web:3a1b93b635bcc9db08c0d0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ESTADO DE CONEXI√ìN
        db.ref(".info/connected").on("value", (snap) => {
            const dot = document.getElementById('status-dot-ui');
            const txt = document.getElementById('status-text-ui');
            if (snap.val() === true) { dot.style.background = "var(--success)"; txt.innerText = "Sincronizado"; }
            else { dot.style.background = "var(--warning)"; txt.innerText = "Modo Local (Sin Internet)"; }
        });

        let todosGrupos = {}; let listaAlumnosActual = []; let indexAlu = 0; let grupoIdGlobal = ""; let sessionIdActual = "";

        // CARGA DE DATOS INICIAL (ESCUELAS Y GRUPOS)
        db.ref('escuelas').on('value', snap => {
            const d = snap.val();
            const listUi = document.getElementById('listaEscuelas');
            const sels = [document.getElementById('selectEscuelaGrupo'), document.getElementById('asis-escuela'), document.getElementById('rep-escuela')];
            sels.forEach(s => { if(s) s.innerHTML = '<option value="">-- Escuela --</option>'; });
            if(listUi) listUi.innerHTML = "";
            if(d) Object.keys(d).forEach(k => {
                sels.forEach(s => { if(s) s.innerHTML += `<option value="${k}">${d[k].apodo}</option>`; });
                if(listUi) listUi.innerHTML += `<div class="item-list"><span><strong>${d[k].apodo}</strong></span><button class="icon-btn" onclick="db.ref('escuelas/${k}').remove()">üóëÔ∏è</button></div>`;
            });
        });

        db.ref('grupos').on('value', snap => {
            todosGrupos = snap.val() || {};
            const listUi = document.getElementById('listaGroups');
            const listArch = document.getElementById('listaArchivados');
            if(listUi) listUi.innerHTML = ""; if(listArch) listArch.innerHTML = "";
            Object.keys(todosGrupos).forEach(k => {
                const g = todosGrupos[k];
                const html = `<div class="item-list"><span>${g.nombreGrupo}</span><div class="item-actions">
                    ${g.estado !== 'archivado' ? `<button class="icon-btn" onclick="prepararImportar('${k}')">üì•</button><button class="icon-btn" onclick="db.ref('grupos/${k}').update({estado:'archivado'})">üìÅ</button>` : `<button class="icon-btn" onclick="db.ref('grupos/${k}').update({estado:'activo'})">üì§</button>`}
                    <button class="icon-btn" onclick="if(confirm('¬øBorrar?')) db.ref('grupos/${k}').remove()">üóëÔ∏è</button></div></div>`;
                if(g.estado === 'archivado') { if(listArch) listArch.innerHTML += html; } else { if(listUi) listUi.innerHTML += html; }
            });
        });

        // FUNCI√ìN CLAVE: INICIAR LISTA (CORREGIDA PARA OFFLINE)
        function iniciarPasarLista() {
            grupoIdGlobal = document.getElementById('asis-grupo').value;
            if(!grupoIdGlobal) return alert("Selecciona un grupo primero");
            
            const d = new Date();
            sessionIdActual = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}_${d.getHours().toString().padStart(2,'0')}${d.getMinutes().toString().padStart(2,'0')}`;

            // Usamos 'on' con una sola ejecuci√≥n para forzar lectura de cach√© local si no hay red
            db.ref('alumnos/'+grupoIdGlobal).on('value', function(snap) {
                const alus = snap.val();
                if(!alus) {
                    alert("No hay alumnos en este grupo. Importa un Excel primero.");
                    return;
                }
                // Convertimos a array y detenemos la escucha para que no se reinicie la lista si vuelve el internet
                db.ref('alumnos/'+grupoIdGlobal).off('value'); 
                
                listaAlumnosActual = Object.keys(alus).map(k => ({id:k, nombre:alus[k].nombre}));
                document.getElementById('asistencia-seleccion').style.display='none';
                document.getElementById('asistencia-flujo').style.display='block';
                indexAlu = 0; 
                mostrarProximoAlu();
            });
        }

        function mostrarProximoAlu() {
            if(indexAlu < listaAlumnosActual.length) {
                document.getElementById('nombre-display').innerText = listaAlumnosActual[indexAlu].nombre;
                document.getElementById('contador-alu').innerText = `Alumno ${indexAlu + 1} de ${listaAlumnosActual.length}`;
            } else {
                alert("¬°Lista finalizada!");
                navegar('home');
            }
        }

        function registrarAsis(st) {
            db.ref(`asistencias/${grupoIdGlobal}/${sessionIdActual}/${listaAlumnosActual[indexAlu].id}`).set({ 
                nombre: listaAlumnosActual[indexAlu].nombre, 
                presente: st 
            });
            indexAlu++; 
            mostrarProximoAlu();
        }

        // --- OTRAS FUNCIONES ---
        function navegar(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (id === 'home') resetearApp();
            document.getElementById(id).classList.add('active'); 
        }
        function guardarEscuela() { /* c√≥digo ya incluido arriba */ }
        function guardarGrupo() { /* c√≥digo ya incluido arriba */ }
        function filtrarGrupos(idEsc, idGrup) {
            const escId = document.getElementById(idEsc).value; const selG = document.getElementById(idGrup);
            selG.innerHTML = '<option value="">-- Grupo --</option>';
            Object.keys(todosGrupos).forEach(k => { if(todosGrupos[k].escuelaId === escId && todosGrupos[k].estado !== 'archivado') selG.innerHTML += `<option value="${k}">${todosGrupos[k].nombreGrupo}</option>`; });
        }
        function prepararImportar(id) { grupoParaExcel = id; document.getElementById('inputExcel').click(); }
        function leerExcel(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const workbook = XLSX.read(evt.target.result, {type: 'binary'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
                data.forEach(row => { if(row[0]) db.ref('alumnos/'+grupoParaExcel).push({ nombre: row[0].toString().toUpperCase() }); });
                alert("Importado correctamente.");
            };
            reader.readAsBinaryString(file);
        }
        function cambiarAlumno(dir) { let n = indexAlu + dir; if(n >= 0 && n < listaAlumnosActual.length) { indexAlu = n; mostrarProximoAlu(); } }
        function resetearApp() { indexAlu = 0; document.getElementById('asistencia-seleccion').style.display='block'; document.getElementById('asistencia-flujo').style.display='none'; }
        
        setInterval(() => {
            const r = document.getElementById('reloj-vivo');
            if(r) r.innerText = new Date().toLocaleTimeString();
        }, 1000);
    </script>
</body>
</html>