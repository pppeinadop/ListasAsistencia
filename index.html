<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Dr. Peinado - Pro Offline</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1C1C1E; --secondary: #8E8E93; --danger: #FF3B30; --success: #34C759; --warning: #FF9500; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); overflow-x: hidden; padding-top: 60px; }
        
        /* Barra de Estado Mejorada */
        #status-bar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #ddd; font-size: 12px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        .screen { display: none; width: 100%; max-width: 600px; margin: auto; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dise√±o de Men√∫ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .menu-item { aspect-ratio: 1/1; background: white; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 16px; transition: transform 0.1s; }
        .menu-item:active { transform: scale(0.95); background: #f9f9f9; }
        .menu-item span { font-size: 40px; margin-bottom: 8px; }

        /* Tarjetas y Botones */
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: bold; font-size: 16px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
        .btn-back { background: none; color: var(--primary); font-size: 17px; font-weight: 600; padding: 10px 0; border: none; margin-bottom: 10px; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #E5E5EA; background: #F2F2F7; font-size: 16px; appearance: none; }
        
        /* Lista de elementos */
        .item-list { display: flex; justify-content: space-between; align-items: center; padding: 14px; border-bottom: 1px solid #F2F2F7; }
        .item-list:last-child { border: none; }
        
        /* Pantalla de pasar lista */
        .name-display { font-size: 34px; font-weight: 800; color: var(--primary); margin: 40px 0; min-height: 100px; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.2; }
        .live-clock { color: var(--primary); font-weight: 700; font-size: 20px; text-align: center; margin-bottom: 20px; }
        
        /* Reporte */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: center; }
        .sticky-col { position: sticky; left: 0; background: white; font-weight: bold; z-index: 2; border-right: 2px solid #ddd; }
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

    <div id="status-bar">
        <div>
            <span id="conn-dot" class="status-dot" style="background:gray"></span>
            <span id="conn-text" style="font-weight: 800;">Cargando...</span>
        </div>
        <button onclick="forzarRespaldo()" style="background: var(--primary); color:white; border:none; padding:5px 12px; border-radius:12px; font-size:10px; font-weight:bold;">RESPALDAR IPAD</button>
    </div>

    <div id="home" class="screen active">
        <h1 style="text-align:center; font-size: 32px; font-weight: 900; color: var(--primary); margin: 20px 0;">Dr. Peinado</h1>
        <div class="menu-grid">
            <button class="menu-item" onclick="navegar('escuelas')"><span>üè´</span>Escuelas</button>
            <button class="menu-item" onclick="navegar('grupos')"><span>üë•</span>Grupos</button>
            <button class="menu-item" onclick="navegar('asistencia')"><span>‚è±Ô∏è</span>Pasar Lista</button>
            <button class="menu-item" onclick="navegar('reportes')"><span>üìä</span>Reportes</button>
        </div>
        <div style="text-align:center; margin-top: 30px; font-size: 11px; color: var(--secondary);">
            √öltima sincronizaci√≥n: <span id="last-sync">--</span>
        </div>
    </div>

    <div id="escuelas" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>üè´ Nueva Escuela</h3>
            <input type="text" id="inNombreE" placeholder="Nombre (Ej. Secundaria T√©cnica)">
            <input type="text" id="inApodoE" placeholder="Siglas (Ej. ST 12)">
            <button class="btn" style="background:var(--primary)" onclick="crearEscuela()">Guardar Escuela</button>
        </div>
        <div class="card">
            <h4>Registradas</h4>
            <div id="displayEscuelas"></div>
        </div>
    </div>

    <div id="grupos" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>üë• Nuevo Grupo</h3>
            <select id="selEscuelaGrupo"></select>
            <input type="text" id="inNombreG" placeholder="Nombre del Grupo">
            <button class="btn" style="background:var(--success)" onclick="crearGrupo()">Crear Grupo</button>
        </div>
        <div class="card">
            <h4>Activos</h4>
            <div id="displayGrupos"></div>
        </div>
        <input type="file" id="inputExcel" style="display:none" onchange="procesarExcel(event)">
    </div>

    <div id="asistencia" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div id="asis-prep" class="card">
            <div id="reloj" class="live-clock">00:00:00</div>
            <select id="selAsisE" onchange="cargarGruposFiltro('selAsisE', 'selAsisG')"></select>
            <select id="selAsisG"></select>
            <button class="btn" style="background:var(--primary)" onclick="comenzarLista()">INICIAR LISTA</button>
        </div>
        <div id="asis-play" class="card" style="display:none; text-align:center">
            <div id="asis-meta" style="font-size: 12px; color: var(--secondary); margin-bottom: 10px;"></div>
            <div id="alu-name" class="name-display">Cargando...</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <button class="btn" style="background:var(--danger); padding:35px; font-size:20px" onclick="marcar(false)">FALTA</button>
                <button class="btn" style="background:var(--success); padding:35px; font-size:20px" onclick="marcar(true)">PRESENTE</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px">
                <button class="btn" style="background:#E5E5EA; color:black;" onclick="moverAlumno(-1)">‚ùÆ Ant.</button>
                <button class="btn" style="background:#E5E5EA; color:black;" onclick="moverAlumno(1)">Sig. ‚ùØ</button>
            </div>
        </div>
    </div>

    <div id="reportes" class="screen">
        <button class="btn-back" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <select id="selRepE" onchange="cargarGruposFiltro('selRepE', 'selRepG')"></select>
            <select id="selRepG"></select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <input type="date" id="fInicio">
                <input type="date" id="fFin">
            </div>
            <button class="btn" style="background:var(--primary)" onclick="verReporte()">üîç Generar Reporte</button>
        </div>
        <div id="rep-box" class="card" style="display:none">
            <div class="table-container">
                <table><thead id="th-rep"></thead><tbody id="tb-rep"></tbody></table>
            </div>
            <button class="btn" style="background:var(--warning)" onclick="exportarExcel()">Exportar a Excel</button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const firebaseConfig = {
            apiKey: "AIzaSyA9uPSxhyy7JJ_05gc00PNcyN31Z3bbzPo",
            databaseURL: "https://listasasistencia-3a3ca-default-rtdb.firebaseio.com",
            projectId: "listasasistencia-3a3ca",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // PERSISTENCIA LOCAL (EL ESPEJO)
        let APP_DATA = JSON.parse(localStorage.getItem('backup_dr_peinado')) || { escuelas: {}, grupos: {}, alumnos: {}, asistencias: {} };
        let index = 0; let lista = []; let gIdActual = ""; let sIdActual = "";

        // SINCRONIZACI√ìN
        function forzarRespaldo() {
            if(!navigator.onLine) return alert("Sin conexi√≥n. No se puede respaldar.");
            db.ref('/').once('value').then(snap => {
                const data = snap.val();
                if(data) {
                    APP_DATA = data;
                    localStorage.setItem('backup_dr_peinado', JSON.stringify(data));
                    localStorage.setItem('dr_peinado_time', new Date().toLocaleString());
                    renderTodo();
                    alert("¬°Copia guardada en el iPad!");
                }
            });
        }

        db.ref(".info/connected").on("value", (snap) => {
            const dot = document.getElementById('conn-dot');
            const txt = document.getElementById('conn-text');
            if (snap.val() === true) {
                dot.style.background = "var(--success)"; txt.innerText = "EN L√çNEA";
                forzarRespaldo(); // Auto-respaldo
            } else {
                dot.style.background = "var(--warning)"; txt.innerText = "MODO OFFLINE";
            }
            renderTodo();
        });

        // NAVEGACI√ìN
        function navegar(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'home') {
                document.getElementById('last-sync').innerText = localStorage.getItem('dr_peinado_time') || "--";
                document.getElementById('asis-prep').style.display = 'block';
                document.getElementById('asis-play').style.display = 'none';
            }
            if(id === 'reportes') {
                document.getElementById('fInicio').value = "2026-02-01";
                document.getElementById('fFin').value = new Date().toISOString().split('T')[0];
            }
        }

        // RENDERIZADO DESDE LOCAL
        function renderTodo() {
            const esc = APP_DATA.escuelas || {};
            const gru = APP_DATA.grupos || {};
            
            // Selectores
            const ids = ['selEscuelaGrupo', 'selAsisE', 'selRepE'];
            ids.forEach(id => {
                const s = document.getElementById(id);
                if(s) {
                    s.innerHTML = '<option value="">-- Escuela --</option>';
                    Object.keys(esc).forEach(k => s.innerHTML += `<option value="${k}">${esc[k].apodo}</option>`);
                }
            });

            // Listas
            const dE = document.getElementById('displayEscuelas');
            if(dE) {
                dE.innerHTML = "";
                Object.keys(esc).forEach(k => dE.innerHTML += `<div class="item-list"><b>${esc[k].apodo}</b><button onclick="borrar('escuelas','${k}')" style="border:none; background:none;">üóëÔ∏è</button></div>`);
            }

            const dG = document.getElementById('displayGrupos');
            if(dG) {
                dG.innerHTML = "";
                Object.keys(gru).forEach(k => dG.innerHTML += `<div class="item-list"><span>${gru[k].nombreGrupo}</span><div><button onclick="preparaExcel('${k}')" style="border:none; background:none; margin-right:10px;">üì•</button><button onclick="borrar('grupos','${k}')" style="border:none; background:none;">üóëÔ∏è</button></div></div>`);
            }
        }

        function cargarGruposFiltro(idE, idG) {
            const eId = document.getElementById(idE).value;
            const selG = document.getElementById(idG);
            selG.innerHTML = '<option value="">-- Grupo --</option>';
            const gs = APP_DATA.grupos || {};
            Object.keys(gs).forEach(k => {
                if(gs[k].escuelaId === eId) selG.innerHTML += `<option value="${k}">${gs[k].nombreGrupo}</option>`;
            });
        }

        // L√ìGICA DE LISTA
        function comenzarLista() {
            gIdActual = document.getElementById('selAsisG').value;
            if(!gIdActual) return alert("Selecciona un grupo");
            
            const alumnosDelGrupo = (APP_DATA.alumnos && APP_DATA.alumnos[gIdActual]) ? APP_DATA.alumnos[gIdActual] : {};
            lista = Object.keys(alumnosDelGrupo).map(k => ({id:k, nombre:alumnosDelGrupo[k].nombre}));

            if(lista.length === 0) return alert("Este grupo no tiene alumnos en la copia local.");

            const d = new Date();
            sIdActual = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}${d.getMinutes()}`;
            
            document.getElementById('asis-prep').style.display = 'none';
            document.getElementById('asis-play').style.display = 'block';
            index = 0; 
            dibujarAlumno();
        }

        function dibujarAlumno() {
            if(index < lista.length) {
                document.getElementById('alu-name').innerText = lista[index].nombre;
                document.getElementById('asis-meta').innerText = `ALUMNO ${index + 1} DE ${lista.length}`;
            } else {
                alert("¬°Lista completada!");
                navegar('home');
            }
        }

        function marcar(p) {
            db.ref(`asistencias/${gIdActual}/${sIdActual}/${lista[index].id}`).set({
                nombre: lista[index].nombre,
                presente: p
            });
            index++; 
            dibujarAlumno();
        }

        function moverAlumno(n) { let v = index + n; if(v >= 0 && v < lista.length) { index = v; dibujarAlumno(); } }

        // EXCEL Y REPORTES
        let gExcel = "";
        function preparaExcel(id) { gExcel = id; document.getElementById('inputExcel').click(); }
        function procesarExcel(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (evt) => {
                const b = XLSX.read(evt.target.result, {type:'binary'});
                const d = XLSX.utils.sheet_to_json(b.Sheets[b.SheetNames[0]], {header:1});
                d.forEach(row => { if(row[0]) db.ref('alumnos/'+gExcel).push({nombre: row[0].toString().toUpperCase()}); });
                alert("Importados. Dale a 'RESPALDAR IPAD' para actualizar.");
            };
            r.readAsBinaryString(f);
        }

        function verReporte() {
            const g = document.getElementById('selRepG').value;
            const ini = document.getElementById('fInicio').value;
            const fin = document.getElementById('fFin').value;
            if(!g) return;

            const asistencias = (APP_DATA.asistencias && APP_DATA.asistencias[g]) ? APP_DATA.asistencias[g] : {};
            const sesiones = Object.keys(asistencias).filter(s => s.split('_')[0] >= ini && s.split('_')[0] <= fin).sort();
            
            if(sesiones.length === 0) return alert("No hay datos en esas fechas.");

            document.getElementById('rep-box').style.display = 'block';
            let h = `<tr><th class="sticky-col">Alumno</th>`;
            sesiones.forEach(s => h += `<th>${s.split('_')[0].slice(-5)}</th>`);
            document.getElementById('th-rep').innerHTML = h + `</tr>`;

            const alus = APP_DATA.alumnos[g] || {};
            let b = "";
            Object.keys(alus).forEach(aId => {
                b += `<tr><td class="sticky-col">${alus[aId].nombre}</td>`;
                sesiones.forEach(s => {
                    const as = asistencias[s][aId];
                    const p = as ? as.presente : null;
                    b += `<td>${p === null ? '-' : (p ? '<span class="dot" style="background:var(--success)"></span>' : '<span class="dot" style="background:var(--danger)"></span>')}</td>`;
                });
                b += `</tr>`;
            });
            document.getElementById('tb-rep').innerHTML = b;
        }

        // AUXILIARES
        function crearEscuela() {
            const n = document.getElementById('inNombreE').value;
            const a = document.getElementById('inApodoE').value;
            if(n && a) db.ref('escuelas').push({nombre:n, apodo:a});
        }
        function crearGrupo() {
            const e = document.getElementById('selEscuelaGrupo').value;
            const n = document.getElementById('inNombreG').value;
            if(e && n) db.ref('grupos').push({escuelaId:e, nombreGrupo:n, estado:'activo'});
        }
        function borrar(p, id) { if(confirm("¬øEliminar?")) db.ref(`${p}/${id}`).remove(); }
        function exportarExcel() {
            const t = document.getElementById('tb-rep').parentElement.cloneNode(true);
            XLSX.writeFile(XLSX.utils.table_to_book(t), "Reporte.xlsx");
        }

        setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleTimeString(); }, 1000);
        
        // Bloqueo de Zoom iPad
        document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    </script>
</body>
</html>