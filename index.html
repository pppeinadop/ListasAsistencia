<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Asistencia Dr. Peinado - Fix Excel</title>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #007AFF; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1C1C1E; --secondary: #8E8E93; --danger: #FF3B30; --success: #34C759; --warning: #FF9500; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .screen { display: none; width: 100%; max-width: 900px; margin: auto; animation: fadeIn 0.2s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; color: white; }
        .btn:active { opacity: 0.7; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: white; }
        .back-btn { background: none; color: var(--primary); border: none; padding: 10px; font-size: 16px; cursor: pointer; font-weight: bold; }
        
        /* Tablas */
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; border: 1px solid #ddd; max-height: 60vh; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 700px; }
        th { background: #f8f8f8; padding: 12px; font-size: 10px; border: 1px solid #eee; position: sticky; top: 0; z-index: 2; }
        td { padding: 10px; font-size: 13px; border: 1px solid #eee; text-align: center; }
        .name-col { text-align: left; font-weight: bold; min-width: 180px; background: white; position: sticky; left: 0; z-index: 3; border-right: 2px solid #eee; }
        
        /* C√≠rculos visuales en pantalla */
        .dot { height: 14px; width: 14px; border-radius: 50%; display: inline-block; }
        .dot-si { background-color: var(--success); }
        .dot-no { background-color: var(--danger); }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { aspect-ratio: 1/1; background: white; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="home" class="screen active">
        <h1 style="text-align:center; margin-top: 40px;">Dr. Peinado</h1>
        <p style="text-align:center; color: var(--secondary); margin-bottom: 40px;">Sistema de Asistencia</p>
        <div class="menu-grid">
            <button class="menu-item" onclick="navegar('escuelas')"><span style="font-size:40px">üè´</span>Escuelas</button>
            <button class="menu-item" onclick="navegar('grupos')"><span style="font-size:40px">üë•</span>Grupos</button>
            <button class="menu-item" onclick="navegar('asistencia')"><span style="font-size:40px">‚è±Ô∏è</span>Asistencia</button>
            <button class="menu-item" onclick="navegar('reportes')"><span style="font-size:40px">üìä</span>Reportes</button>
        </div>
    </div>

    <div id="escuelas" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>Nueva Escuela</h3>
            <input type="text" id="nombreEscuela" placeholder="Nombre completo">
            <input type="text" id="apodoEscuela" placeholder="Siglas">
            <button class="btn" style="background:var(--primary)" onclick="guardarEscuela()">Guardar</button>
        </div>
        <div class="card"><div id="listaEscuelas"></div></div>
    </div>

    <div id="grupos" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>Nuevo Grupo</h3>
            <select id="selectEscuelaGrupo"></select>
            <input type="text" id="nombreGrupo" placeholder="Nombre del Grupo">
            <button class="btn" style="background:var(--success)" onclick="guardarGrupo()">Crear Grupo</button>
        </div>
        <input type="file" id="inputExcel" style="display:none" accept=".xlsx, .xls" onchange="leerExcel(event)">
        <div class="card"><h3>Grupos Activos</h3><div id="listaGrupos"></div></div>
    </div>

    <div id="asistencia" class="screen">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div id="asistencia-seleccion" class="card">
            <h3>Iniciar Pase de Lista</h3>
            <select id="asis-escuela" onchange="filtrarGrupos('asis-escuela', 'asis-grupo')"></select>
            <select id="asis-grupo"></select>
            <button class="btn" style="background:var(--primary)" onclick="iniciarPasarLista()">Comenzar</button>
        </div>
        <div id="asistencia-flujo" class="card" style="display:none; text-align:center">
            <div id="nombre-display" style="font-size:32px; font-weight:800; margin:40px 0; color:var(--primary)"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <button class="btn" style="background:var(--danger); padding:30px" onclick="registrarAsis(false)">FALTA</button>
                <button class="btn" style="background:var(--success); padding:30px" onclick="registrarAsis(true)">PRESENTE</button>
            </div>
        </div>
    </div>

    <div id="reportes" class="screen" style="max-width:100%">
        <button class="back-btn" onclick="navegar('home')">‚ùÆ Inicio</button>
        <div class="card">
            <h3>Reporte Multifuncional</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <select id="rep-escuela" onchange="filtrarGrupos('rep-escuela', 'rep-grupo')"></select>
                <select id="rep-grupo" onchange="consultarReporte()"></select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
                <div><label>Desde:</label><input type="date" id="fecha-inicio" onchange="consultarReporte()"></div>
                <div><label>Hasta:</label><input type="date" id="fecha-fin" onchange="consultarReporte()"></div>
            </div>
            
            <div id="reporte-vacio" style="text-align:center; padding:20px; color:gray">Selecciona grupo y fechas.</div>
            <div id="reporte-tabla-cont" style="display:none">
                <div class="table-container">
                    <table id="tabla-datos">
                        <thead id="head-reporte"></thead>
                        <tbody id="body-reporte"></tbody>
                    </table>
                </div>
                <button class="btn" style="background:var(--warning)" onclick="exportarExcelFull()">Exportar Excel üì•</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9uPSxhyy7JJ_05gc00PNcyN31Z3bbzPo",
            authDomain: "listasasistencia-3a3ca.firebaseapp.com",
            databaseURL: "https://listasasistencia-3a3ca-default-rtdb.firebaseio.com",
            projectId: "listasasistencia-3a3ca",
            storageBucket: "listasasistencia-3a3ca.firebasestorage.app",
            messagingSenderId: "892289957745",
            appId: "1:892289957745:web:3a1b93b635bcc9db08c0d0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let todosGrupos = {};
        let listaAlumnosActual = [];
        let indexAlu = 0;
        let grupoIdGlobal = "";
        let sessionIdActual = "";

        function navegar(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (id === 'home') resetearTodo();
            if (id === 'reportes') {
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fecha-fin').value = hoy;
                const haceMes = new Date(); haceMes.setDate(haceMes.getDate() - 30);
                document.getElementById('fecha-inicio').value = haceMes.toISOString().split('T')[0];
            }
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        function resetearTodo() {
            document.querySelectorAll('input').forEach(i => i.value = "");
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            indexAlu = 0;
            listaAlumnosActual = [];
            grupoIdGlobal = "";
            document.getElementById('asistencia-seleccion').style.display = 'block';
            document.getElementById('asistencia-flujo').style.display = 'none';
            document.getElementById('reporte-tabla-cont').style.display = 'none';
            document.getElementById('reporte-vacio').style.display = 'block';
        }

        // --- L√ìGICA GRUPOS ---
        function filtrarGrupos(idEsc, idGrup) {
            const escId = document.getElementById(idEsc).value;
            const selG = document.getElementById(idGrup);
            selG.innerHTML = '<option value="">-- Grupo --</option>';
            if(!escId) return;
            Object.keys(todosGrupos).forEach(k => {
                if(todosGrupos[k].escuelaId === escId) selG.innerHTML += `<option value="${k}">${todosGrupos[k].nombreGrupo}</option>`;
            });
        }

        function guardarEscuela() {
            const n = document.getElementById('nombreEscuela').value;
            const a = document.getElementById('apodoEscuela').value;
            if(n && a) db.ref('escuelas').push({ nombre: n, apodo: a }).then(() => navegar('home'));
        }

        function guardarGrupo() {
            const eId = document.getElementById('selectEscuelaGrupo').value;
            const eTxt = document.getElementById('selectEscuelaGrupo').options[document.getElementById('selectEscuelaGrupo').selectedIndex].text;
            const nG = document.getElementById('nombreGrupo').value;
            if(eId && nG) db.ref('grupos').push({ escuelaId: eId, escuelaTxt: eTxt, nombreGrupo: nG }).then(() => navegar('home'));
        }

        function leerExcel(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                const rows = XLSX.utils.sheet_to_row_object_array(XLSX.read(evt.target.result, {type:'binary'}).Sheets[XLSX.read(evt.target.result, {type:'binary'}).SheetNames[0]]);
                rows.forEach(r => {
                    const nom = r.Nombre || r.nombre || r.ALUMNO;
                    if(nom) db.ref('alumnos/'+grupoIdGlobal).push({ nombre: nom });
                });
                alert("Importados"); navegar('home');
            };
            reader.readAsBinaryString(file);
        }

        // --- ASISTENCIA ---
        function iniciarPasarLista() {
            grupoIdGlobal = document.getElementById('asis-grupo').value;
            if(!grupoIdGlobal) return;
            const ahora = new Date();
            sessionIdActual = ahora.toISOString().split('T')[0] + "_" + ahora.getHours().toString().padStart(2,'0') + ahora.getMinutes().toString().padStart(2,'0');
            db.ref('alumnos/'+grupoIdGlobal).once('value', snap => {
                const d = snap.val();
                if(!d) return alert("Sin alumnos");
                listaAlumnosActual = Object.keys(d).map(k => ({id: k, nombre: d[k].nombre}));
                document.getElementById('asistencia-seleccion').style.display='none';
                document.getElementById('asistencia-flujo').style.display='block';
                mostrarProximoAlu();
            });
        }

        function mostrarProximoAlu() {
            if(indexAlu < listaAlumnosActual.length) {
                document.getElementById('nombre-display').innerText = listaAlumnosActual[indexAlu].nombre;
            } else {
                alert("Guardado."); navegar('home');
            }
        }

        function registrarAsis(st) {
            db.ref(`asistencias/${grupoIdGlobal}/${sessionIdActual}/${listaAlumnosActual[indexAlu].id}`).set({
                nombre: listaAlumnosActual[indexAlu].nombre,
                presente: st
            });
            indexAlu++;
            mostrarProximoAlu();
        }

        // --- REPORTES ---
        function consultarReporte() {
            const gId = document.getElementById('rep-grupo').value;
            const inicio = document.getElementById('fecha-inicio').value;
            const fin = document.getElementById('fecha-fin').value;
            if(!gId) return;

            db.ref(`asistencias/${gId}`).once('value', snap => {
                const d = snap.val();
                const cont = document.getElementById('reporte-tabla-cont');
                const vacio = document.getElementById('reporte-vacio');
                if(!d) { cont.style.display='none'; vacio.style.display='block'; return; }

                const sesiones = Object.keys(d).filter(sId => sId.substring(0, 10) >= inicio && sId.substring(0, 10) <= fin).sort();
                if(sesiones.length === 0) { cont.style.display='none'; vacio.style.display='block'; return; }

                cont.style.display='block'; vacio.style.display='none';
                
                let headHtml = `<tr><th class="name-col">Alumno</th>`;
                sesiones.forEach(sId => {
                    const f = sId.substring(8, 10) + "/" + sId.substring(5, 7);
                    const h = sId.substring(11, 13) + ":" + sId.substring(13, 15);
                    headHtml += `<th>${f} ${h}</th>`;
                });
                headHtml += `</tr>`;
                document.getElementById('head-reporte').innerHTML = headHtml;

                db.ref('alumnos/'+gId).once('value', snapAlu => {
                    const alus = snapAlu.val();
                    let bodyHtml = "";
                    Object.keys(alus).forEach(aId => {
                        bodyHtml += `<tr><td class="name-col">${alus[aId].nombre}</td>`;
                        sesiones.forEach(sId => {
                            const reg = d[sId][aId];
                            // Aqu√≠ est√° el truco: data-excel guarda el texto para el Excel
                            const val = reg ? (reg.presente ? 'ASISTENCIA' : 'FALTA') : '-';
                            const dot = reg ? (reg.presente ? 'dot-si' : 'dot-no') : '';
                            bodyHtml += `<td data-excel="${val}">${reg ? `<span class="dot ${dot}"></span>` : '-'}</td>`;
                        });
                        bodyHtml += `</tr>`;
                    });
                    document.getElementById('body-reporte').innerHTML = bodyHtml;
                });
            });
        }

        // --- FUNCI√ìN DE EXPORTACI√ìN CORREGIDA ---
        function exportarExcelFull() {
            // 1. Clonamos la tabla para no arruinar la vista del iPad
            const tablaOriginal = document.getElementById("tabla-datos");
            const clon = tablaOriginal.cloneNode(true);

            // 2. Buscamos todas las celdas que tienen c√≠rculos y los reemplazamos por texto
            clon.querySelectorAll('td').forEach(td => {
                if (td.hasAttribute('data-excel')) {
                    td.innerText = td.getAttribute('data-excel');
                }
            });

            // 3. Exportamos el clon (que ahora tiene texto "ASISTENCIA" o "FALTA")
            const wb = XLSX.utils.table_to_book(clon);
            XLSX.writeFile(wb, "Reporte_Asistencia_DrPeinado.xlsx");
        }

        // --- SYNC ---
        db.ref('escuelas').on('value', snap => {
            const d = snap.val();
            const sels = [document.getElementById('selectEscuelaGrupo'), document.getElementById('asis-escuela'), document.getElementById('rep-escuela')];
            const list = document.getElementById('listaEscuelas'); if(list) list.innerHTML = "";
            sels.forEach(s => { if(s) s.innerHTML = '<option value="">-- Escuela --</option>'; });
            if(d) Object.keys(d).forEach(k => {
                if(list) list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee">${d[k].apodo} <span onclick="db.ref('escuelas/${k}').remove()" style="float:right">üóëÔ∏è</span></div>`;
                sels.forEach(s => { if(s) s.innerHTML += `<option value="${k}">${d[k].apodo}</option>`; });
            });
        });

        db.ref('grupos').on('value', snap => {
            todosGrupos = snap.val() || {};
            const list = document.getElementById('listaGrupos'); if(list) list.innerHTML = "";
            Object.keys(todosGrupos).forEach(k => {
                if(list) list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee"><strong>${todosGrupos[k].nombreGrupo}</strong> 
                <span onclick="db.ref('grupos/${k}').remove()" style="float:right; margin-left:15px">üóëÔ∏è</span>
                <span onclick="grupoIdGlobal='${k}';document.getElementById('inputExcel').click()" style="float:right">üì•</span></div>`;
            });
        });
    </script>
</body>
</html>